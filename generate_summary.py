#!/usr/bin/env python3
"""
Enhanced GitHub Actions job summary generator with:
- Reliability scores
- TTFT metrics
- Error diagnostics
- Performance trends
"""
import json
import os
import sys

if not os.path.exists('data.json'):
    print("âš ï¸ data.json not found - benchmark may have failed")
    sys.exit(1)

with open('data.json') as f:
    data = json.load(f)

print(f"### ğŸ¯ Benchmark Results - v3.0\n")
print(f"**Last Updated:** {data['last_updated']}\n")
print(f"**Total Providers:** {len(data['results'])}\n")

online = [r for r in data['results'] if r['status'] == 'Online']
offline = [r for r in data['results'] if r['status'] != 'Online']

# Online providers with enhanced metrics
if online:
    print("### âœ… Online Providers\n")
    print("| Rank | Provider | Model | Time | TTFT | TPS | Smoothness | Cost |")
    print("|------|----------|-------|------|------|-----|------------|------|")
    
    for i, r in enumerate(online, 1):
        medal = "ğŸ¥‡" if i == 1 else "ğŸ¥ˆ" if i == 2 else "ğŸ¥‰" if i == 3 else f"#{i}"
        cost = "FREE" if r['cost_per_request'] == 0 else f"${r['cost_per_request']:.5f}"
        ttft = f"{r['ttft']:.3f}s" if r.get('ttft') else "N/A"
        smoothness = f"{r['streaming_smoothness']:.2f}" if r.get('streaming_smoothness') else "N/A"
        print(f"| {medal} | {r['provider']} | {r['model'][:30]} | {r['time']:.2f}s | {ttft} | {r['tokens_per_second']:.0f} | {smoothness} | {cost} |")
    print("")

# Offline providers with error info
if offline:
    print("### âŒ Offline Providers\n")
    print("| Provider | Model | Error Type | Details |")
    print("|----------|-------|------------|---------|")
    for r in offline:
        error_info = r.get('error_info', {})
        error_type = error_info.get('type', 'UNKNOWN')
        error_msg = error_info.get('message', 'No details')[:60]
        print(f"| {r['provider']} | {r['model'][:25]} | {error_type} | {error_msg}... |")
    print("")

# Reliability scores
reliability_scores = data.get('reliability_scores', {})
if reliability_scores:
    print("### ğŸ“Š Reliability Scores (Last 30 Tests)\n")
    print("| Provider | Uptime % |")
    print("|----------|----------|")
    sorted_reliability = sorted(reliability_scores.items(), key=lambda x: x[1], reverse=True)
    for provider, score in sorted_reliability:
        emoji = "ğŸŸ¢" if score >= 95 else "ğŸŸ¡" if score >= 80 else "ğŸ”´"
        print(f"| {emoji} {provider} | {score}% |")
    print("")

# Performance insights
if online:
    fastest = min(online, key=lambda x: x['time'])
    fastest_ttft = min([r for r in online if r.get('ttft')], key=lambda x: x['ttft']) if any(r.get('ttft') for r in online) else None
    highest_tps = max(online, key=lambda x: x['tokens_per_second'])
    cheapest = min(online, key=lambda x: x['cost_per_request'])
    
    print("### ğŸ† Performance Leaders\n")
    print(f"- **âš¡ Fastest Overall:** {fastest['provider']} ({fastest['time']:.2f}s)")
    if fastest_ttft:
        print(f"- **ğŸš€ Fastest TTFT:** {fastest_ttft['provider']} ({fastest_ttft['ttft']:.3f}s)")
    print(f"- **ğŸ“ˆ Highest TPS:** {highest_tps['provider']} ({highest_tps['tokens_per_second']:.0f} tokens/s)")
    print(f"- **ğŸ’° Most Cost-Effective:** {cheapest['provider']} ({cheapest['cost_per_request'] if cheapest['cost_per_request'] > 0 else 'FREE'})")
    print("")

# Metadata
metadata = data.get('metadata', {})
if metadata:
    print("### âš™ï¸ Test Configuration\n")
    print(f"- **Version:** {metadata.get('version', 'Unknown')}")
    print(f"- **Parallel Testing:** {'âœ… Enabled' if metadata.get('parallel_testing') else 'âŒ Disabled'}")
    print(f"- **Streaming:** {'âœ… Enabled' if metadata.get('streaming_enabled') else 'âŒ Disabled'}")
    print(f"- **Timeout:** {metadata.get('timeout', 60)}s")
    print(f"- **Retries:** {metadata.get('retries', 3)}")
    print("")

print(f"**History Entries:** {len(data.get('history', []))}")
print(f"\n---\n*Generated by BRAIAIN Speed Index v3.0*")
