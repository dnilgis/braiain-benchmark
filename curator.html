<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BRAIAIN â€” Challenge Curator</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Orbitron:wght@700;900&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --border: #1e1e2a;
    --text: #e0e0e8;
    --muted: #6a6a7a;
    --cyan: #00e5ff;
    --green: #00ff9d;
    --red: #ff003c;
    --orange: #ff9500;
    --yellow: #ffd600;
    --purple: #a855f7;
    --font-mono: 'Space Mono', monospace;
    --font-head: 'Orbitron', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--bg); color: var(--text);
    font-family: var(--font-mono); font-size: 14px;
    min-height: 100vh; padding: 20px; max-width: 1200px; margin: 0 auto;
  }

  h1 { font-family: var(--font-head); font-size: 1.5rem; color: var(--cyan); letter-spacing: 4px; margin-bottom: 4px; }
  .subtitle { color: var(--muted); font-size: .65rem; letter-spacing: 2px; margin-bottom: 24px; }

  .panel {
    background: var(--surface); border: 1px solid var(--border);
    padding: 20px; margin-bottom: 20px; border-radius: 4px;
  }
  .panel h2 {
    font-family: var(--font-head); font-size: .8rem; letter-spacing: 3px;
    margin-bottom: 14px; display: flex; align-items: center; gap: 10px;
  }
  .step-num {
    display: inline-flex; align-items: center; justify-content: center;
    width: 26px; height: 26px; border-radius: 50%; font-size: .65rem;
    font-weight: 900; flex-shrink: 0;
  }

  label { display: block; color: var(--muted); font-size: .6rem; letter-spacing: 1px; margin-bottom: 4px; text-transform: uppercase; }
  input, textarea, select {
    padding: 8px 12px; background: var(--bg); border: 1px solid var(--border);
    color: var(--text); font-family: var(--font-mono); font-size: .8rem;
    border-radius: 2px; outline: none; width: 100%;
  }
  input:focus, textarea:focus, select:focus { border-color: var(--cyan); }
  .hint { color: var(--muted); font-size: .55rem; margin-top: 3px; }
  .hint a { color: var(--cyan); }
  .row { display: flex; gap: 12px; flex-wrap: wrap; }
  .row > div { flex: 1; min-width: 100px; }

  .btn {
    padding: 10px 20px; font-family: var(--font-head); font-size: .65rem;
    letter-spacing: 2px; cursor: pointer; border: none;
    font-weight: 700; transition: all .2s; display: inline-flex; align-items: center; gap: 8px;
  }
  .btn-cyan { background: var(--cyan); color: var(--bg); }
  .btn-cyan:hover { background: #33ecff; }
  .btn-green { background: var(--green); color: var(--bg); }
  .btn-green:hover { background: #33ffb3; }
  .btn-orange { background: var(--orange); color: var(--bg); }
  .btn-orange:hover { filter: brightness(1.15); }
  .btn-red { background: var(--red); color: white; }
  .btn-red:hover { filter: brightness(1.15); }
  .btn-yellow { background: var(--yellow); color: var(--bg); }
  .btn-yellow:hover { filter: brightness(1.15); }
  .btn-purple { background: var(--purple); color: white; }
  .btn-purple:hover { filter: brightness(1.15); }
  .btn-outline { background: transparent; color: var(--cyan); border: 1px solid var(--cyan); }
  .btn-outline:hover { background: rgba(0,229,255,.08); }
  .btn-sm { padding: 6px 14px; font-size: .55rem; }
  .btn:disabled { opacity: .35; cursor: not-allowed; }

  .search-row { display: flex; gap: 8px; margin-bottom: 10px; }
  .search-row input { flex: 1; }

  .source-toggle { display: flex; gap: 0; margin-bottom: 10px; }
  .source-toggle button {
    padding: 6px 14px; font-family: var(--font-head); font-size: .55rem;
    letter-spacing: 1px; cursor: pointer; border: 1px solid var(--border);
    background: var(--bg); color: var(--muted); transition: all .2s;
  }
  .source-toggle button:first-child { border-radius: 2px 0 0 2px; }
  .source-toggle button:last-child { border-radius: 0 2px 2px 0; }
  .source-toggle button:not(:first-child) { border-left: none; }
  .source-toggle button.active { background: var(--green); color: var(--bg); border-color: var(--green); }

  .img-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px; margin-top: 10px;
  }
  .img-card {
    position: relative; background: var(--bg); border: 2px solid var(--border);
    border-radius: 4px; overflow: hidden; cursor: pointer; transition: all .15s;
  }
  .img-card:hover { border-color: var(--cyan); }
  .img-card.selected { border-color: var(--green); box-shadow: 0 0 14px rgba(0,255,157,.2); }
  .img-card img { width: 100%; height: 150px; object-fit: cover; display: block; }
  .img-card .meta { padding: 6px 8px; font-size: .55rem; color: var(--muted); line-height: 1.4; }
  .img-card .meta b { color: var(--text); }
  .img-card .src-badge {
    position: absolute; top: 5px; left: 5px;
    font-family: var(--font-head); font-size: .4rem;
    padding: 2px 6px; letter-spacing: 1px; font-weight: 700;
    border-radius: 2px; background: rgba(0,0,0,.7);
  }
  .img-card .src-badge.unsplash { color: var(--cyan); }
  .img-card .src-badge.pexels { color: var(--green); }
  .img-card .sel-badge {
    position: absolute; top: 5px; right: 5px;
    font-family: var(--font-head); font-size: .5rem;
    padding: 2px 8px; letter-spacing: 1px; font-weight: 700;
    display: none; border-radius: 2px;
  }
  .img-card.selected .sel-badge { display: block; background: var(--green); color: var(--bg); }

  .slot-strip { display: flex; gap: 8px; overflow-x: auto; padding: 8px 0; }
  .slot {
    flex-shrink: 0; width: 110px; height: 72px; position: relative;
    border-radius: 3px; overflow: hidden;
  }
  .slot img { width: 100%; height: 100%; object-fit: cover; }
  .slot .rm { position: absolute; top: 2px; right: 2px; background: var(--red); color: white;
    border: none; width: 16px; height: 16px; font-size: 9px; cursor: pointer;
    font-family: var(--font-mono); border-radius: 2px; display: flex; align-items: center; justify-content: center; }
  .slot .sn { position: absolute; bottom: 0; left: 0; right: 0;
    background: rgba(0,0,0,.75); text-align: center;
    font-size: .45rem; padding: 2px; letter-spacing: 1px; }
  .slot-empty {
    flex-shrink: 0; width: 110px; height: 72px;
    border: 1px dashed var(--border); border-radius: 3px;
    display: flex; align-items: center; justify-content: center;
    color: var(--muted); font-size: .5rem; letter-spacing: 1px;
  }
  .slot-empty.human { border-color: rgba(0,255,157,.3); color: var(--green); }
  .slot-empty.ai { border-color: rgba(255,0,60,.3); color: var(--red); }

  .ai-card {
    background: var(--bg); border: 1px solid var(--border); border-radius: 4px;
    padding: 14px; margin-bottom: 10px;
  }
  .ai-card .ai-num { font-family: var(--font-head); font-size: .6rem; color: var(--red); letter-spacing: 1px; margin-bottom: 6px; }
  .ai-card textarea { font-size: .75rem; line-height: 1.5; resize: vertical; min-height: 50px; margin-bottom: 8px; }
  .ai-card .actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .ai-card .preview { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
  .ai-card .preview img {
    width: 160px; height: 110px; object-fit: cover; border-radius: 3px;
    border: 2px solid var(--border); cursor: pointer; transition: all .15s;
  }
  .ai-card .preview img:hover { border-color: var(--cyan); }
  .ai-card .preview img.picked { border-color: var(--red); box-shadow: 0 0 10px rgba(255,0,60,.3); }
  .ai-card .tip-row { margin-top: 8px; }
  .ai-card .tip-row input { font-size: .7rem; }

  .status { color: var(--muted); font-size: .65rem; padding: 4px 0; min-height: 20px; }
  .status.err { color: var(--red); }
  .status.ok { color: var(--green); }

  .spin { display: inline-block; width: 12px; height: 12px; border: 2px solid var(--muted);
    border-top-color: var(--cyan); border-radius: 50%; animation: sp .5s linear infinite; }
  @keyframes sp { to { transform: rotate(360deg); } }

  #json-out, #daily-json-out {
    width: 100%; padding: 12px;
    background: var(--bg); border: 1px solid var(--border);
    color: var(--green); font-family: var(--font-mono); font-size: .65rem;
    resize: vertical; outline: none; margin-top: 10px;
  }
  #json-out { height: 300px; }
  #daily-json-out { height: 120px; color: var(--cyan); }

  .counter { font-family: var(--font-head); font-size: .7rem; }
  .counter .n { color: var(--cyan); }

  hr { border: none; border-top: 1px solid var(--border); margin: 12px 0; }

  .preview-grid {
    display: grid; grid-template-columns: repeat(5, 1fr);
    gap: 10px; margin-top: 12px;
  }
  .preview-card {
    position: relative; border-radius: 4px; overflow: hidden;
    border: 2px solid var(--border); aspect-ratio: 4/3;
  }
  .preview-card img { width: 100%; height: 100%; object-fit: cover; }
  .preview-card .round-num {
    position: absolute; top: 4px; left: 4px;
    background: rgba(0,0,0,.8); color: var(--cyan);
    font-family: var(--font-head); font-size: .5rem;
    padding: 2px 6px; border-radius: 2px; letter-spacing: 1px;
  }
  .preview-card .type-badge {
    position: absolute; bottom: 4px; right: 4px;
    font-family: var(--font-head); font-size: .45rem;
    padding: 2px 6px; border-radius: 2px; letter-spacing: 1px;
  }
  .preview-card .type-badge.human { background: var(--green); color: var(--bg); }
  .preview-card .type-badge.ai { background: var(--red); color: white; }

  .days-list {
    display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px;
  }
  .day-chip {
    padding: 6px 12px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 3px; font-size: .65rem; cursor: pointer; transition: all .15s;
    color: var(--text); display: flex; align-items: center; gap: 6px;
  }
  .day-chip:hover { border-color: var(--cyan); background: rgba(0,229,255,.05); }
  .day-chip.picked { border-color: var(--cyan); background: rgba(0,229,255,.12); color: var(--cyan); }
  .day-chip .day-emoji { font-size: .8rem; }

  .warning-box {
    background: rgba(255,149,0,.08); border: 1px solid var(--orange);
    border-radius: 4px; padding: 10px 14px; margin-top: 10px;
    font-size: .65rem; color: var(--orange); display: none;
  }
  .warning-box.visible { display: block; }

  .quality-bar {
    display: flex; gap: 16px; margin-top: 12px; padding: 10px;
    background: var(--bg); border-radius: 4px; flex-wrap: wrap;
  }
  .q-stat { text-align: center; }
  .q-stat .q-label { font-size: .5rem; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }
  .q-stat .q-val { font-family: var(--font-head); font-size: .8rem; margin-top: 2px; }
  .q-stat .q-val.good { color: var(--green); }
  .q-stat .q-val.warn { color: var(--orange); }
  .q-stat .q-val.bad { color: var(--red); }

  .model-select { max-width: 360px; margin-bottom: 12px; }
  .model-select select { font-size: .7rem; }

  .export-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
  .export-section h3 {
    font-family: var(--font-head); font-size: .7rem; letter-spacing: 2px;
    margin-bottom: 8px;
  }
  .export-section h3.cyan { color: var(--cyan); }
  .export-section h3.purple { color: var(--purple); }

  @media (max-width: 768px) {
    .preview-grid { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>

<h1>BRAIAIN CURATOR</h1>
<div class="subtitle">FIND 5 REAL PHOTOS + GENERATE 5 AI IMAGES â†’ EXPORT CHALLENGE</div>

<!-- â•â•â• STEP 1: CONFIG â•â•â• -->
<div class="panel">
  <h2><span class="step-num" style="background:var(--cyan);color:var(--bg)">1</span> CHALLENGE CONFIG</h2>
  <div class="row">
    <div style="max-width:80px"><label>Day #</label><input type="number" id="cfg-day" value="2" min="1"></div>
    <div style="max-width:160px"><label>Date</label><input type="date" id="cfg-date"></div>
    <div><label>Category / Theme</label><input type="text" id="cfg-cat" placeholder="e.g. National Pizza Day"></div>
    <div style="max-width:70px"><label>Emoji</label><input type="text" id="cfg-emoji" placeholder="ğŸ•"></div>
  </div>
  <div class="row" style="margin-top:10px;">
    <div><label>Subtitle / Tagline</label><input type="text" id="cfg-subtitle" placeholder="Auto-generated after picking theme, or type your own"></div>
    <div style="max-width:180px;display:flex;align-items:flex-end;">
      <button class="btn btn-purple btn-sm" onclick="autoTagline()" style="width:100%">âœ¨ AUTO TAGLINE</button>
    </div>
  </div>
  <hr>
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
    <button class="btn btn-yellow btn-sm" onclick="lookupDays()">ğŸ“… WHAT'S TODAY?</button>
    <button class="btn btn-outline btn-sm" onclick="document.getElementById('import-file').click()">ğŸ“‚ IMPORT JSON</button>
    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importJSON(event)">
    <span class="status" id="import-status"></span>
  </div>
  <div class="status" id="days-status"></div>
  <div class="days-list" id="days-list"></div>
</div>

<!-- â•â•â• STEP 2: API KEYS â•â•â• -->
<div class="panel">
  <h2><span class="step-num" style="background:var(--orange);color:var(--bg)">2</span> API KEYS (saved in your browser)</h2>
  <div class="row">
    <div>
      <label>Unsplash Access Key</label>
      <input type="text" id="key-unsplash" placeholder="Paste key here">
      <div class="hint">Free â†’ <a href="https://unsplash.com/developers" target="_blank">unsplash.com/developers</a></div>
    </div>
    <div>
      <label>Pexels API Key</label>
      <input type="text" id="key-pexels" placeholder="Paste key here">
      <div class="hint">Free â†’ <a href="https://www.pexels.com/api/" target="_blank">pexels.com/api</a></div>
    </div>
    <div>
      <label>Google AI Studio Key</label>
      <input type="text" id="key-gemini" placeholder="Paste key here">
      <div class="hint">Free â†’ <a href="https://aistudio.google.com/app/apikey" target="_blank">aistudio.google.com</a></div>
    </div>
  </div>
</div>

<!-- â•â•â• STEP 3: REAL PHOTOS â•â•â• -->
<div class="panel">
  <h2><span class="step-num" style="background:var(--green);color:var(--bg)">3</span> <span style="color:var(--green)">REAL PHOTOS</span> â€” PICK 5</h2>
  <div class="source-toggle" id="photo-source-toggle">
    <button class="active" data-src="unsplash" onclick="setPhotoSource('unsplash')">UNSPLASH</button>
    <button data-src="pexels" onclick="setPhotoSource('pexels')">PEXELS</button>
    <button data-src="both" onclick="setPhotoSource('both')">BOTH</button>
  </div>
  <div class="search-row">
    <input type="text" id="us-query" placeholder="Search photos (e.g. ice cream cone summer)">
    <button class="btn btn-green btn-sm" onclick="searchPhotos()">SEARCH</button>
  </div>
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div class="status" id="us-status"></div>
    <div class="counter"><span class="n" id="real-count">0</span>/5 selected</div>
  </div>
  <label style="color:var(--green)">SELECTED</label>
  <div class="slot-strip" id="real-strip"></div>
  <div class="img-grid" id="us-grid"></div>
</div>

<!-- â•â•â• STEP 4: AI IMAGES â•â•â• -->
<div class="panel">
  <h2><span class="step-num" style="background:var(--red);color:white">4</span> <span style="color:var(--red)">AI IMAGES</span> â€” GENERATE 5</h2>
  <p style="color:var(--muted);font-size:.65rem;margin-bottom:12px;">
    Write a prompt, then either Generate via API or <b style="color:var(--cyan)">Copy Prompt</b> â†’ paste into 
    <a href="https://gemini.google.com" target="_blank" style="color:var(--cyan)">Gemini web</a> â†’ Upload result.
  </p>
  <div class="model-select">
    <label>Gemini Image Model</label>
    <select id="gemini-model">
      <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp (recommended)</option>
      <option value="gemini-2.0-flash-preview-image-generation">gemini-2.0-flash-preview-image-generation</option>
      <option value="imagen-3.0-generate-002">imagen-3.0-generate-002</option>
    </select>
    <div class="hint">If generation fails, try different model or use Copy Prompt â†’ Gemini web â†’ Upload</div>
  </div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px;">
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn btn-yellow btn-sm" onclick="suggestPrompts()">âœ¨ SUGGEST PROMPTS</button>
      <button class="btn btn-orange btn-sm" onclick="generateAllAI()" id="gen-all-btn">ğŸš€ GENERATE ALL</button>
      <button class="btn btn-outline btn-sm" onclick="autoTips()">ğŸ’¡ AUTO TIPS</button>
    </div>
    <div class="counter"><span class="n" id="ai-count">0</span>/5 selected</div>
  </div>
  <div class="status" id="ai-status-global"></div>
  <label style="color:var(--red)">SELECTED</label>
  <div class="slot-strip" id="ai-strip"></div>
  <hr>
  <div id="ai-cards"></div>
</div>

<!-- â•â•â• STEP 5: PREVIEW â•â•â• -->
<div class="panel">
  <h2><span class="step-num" style="background:var(--yellow);color:var(--bg)">5</span> CHALLENGE PREVIEW</h2>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px;">
    <button class="btn btn-yellow btn-sm" onclick="renderPreview()">ğŸ‘ PREVIEW</button>
    <button class="btn btn-outline btn-sm" onclick="reshufflePreview()">ğŸ”€ RE-SHUFFLE</button>
  </div>
  <div class="status" id="preview-status"></div>
  <div class="warning-box" id="pattern-warning"></div>
  <div class="quality-bar" id="quality-bar" style="display:none;"></div>
  <div class="preview-grid" id="preview-grid"></div>
</div>

<!-- â•â•â• STEP 6: EXPORT â•â•â• -->
<div class="panel">
  <h2><span class="step-num" style="background:var(--cyan);color:var(--bg)">6</span> EXPORT CHALLENGE</h2>
  <p style="color:var(--muted);font-size:.65rem;margin-bottom:12px;">
    JSON â†’ <code style="color:var(--cyan)">challenges/</code> &nbsp;|&nbsp; AI images â†’ <code style="color:var(--cyan)">images/</code> &nbsp;|&nbsp; 
    Snippet â†’ paste into <code style="color:var(--purple)">daily.json</code>
  </p>
  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:6px;">
    <button class="btn btn-cyan" onclick="generateJSON()">GENERATE JSON</button>
    <button class="btn btn-green" onclick="downloadAll()">â¬‡ DOWNLOAD ALL</button>
  </div>
  <div class="status" id="export-status"></div>

  <div class="export-section">
    <h3 class="cyan">CHALLENGE JSON â†’ challenges/[date].json</h3>
    <button class="btn btn-outline btn-sm" onclick="copyJSON()" style="margin-bottom:4px">ğŸ“‹ COPY</button>
    <textarea id="json-out" placeholder="Challenge JSON will appear here..."></textarea>
  </div>

  <div class="export-section">
    <h3 class="purple">DAILY.JSON SNIPPET â†’ paste into daily.json</h3>
    <button class="btn btn-purple btn-sm" onclick="copyDailyJSON()" style="margin-bottom:4px">ğŸ“‹ COPY SNIPPET</button>
    <textarea id="daily-json-out" placeholder="daily.json entry will appear here after generating..."></textarea>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const REAL = [null, null, null, null, null];
const AI   = [null, null, null, null, null];
let photoResults = [];
let photoSource = 'unsplash';

const defaultPrompts = [
  'A photorealistic photograph of [subject], natural lighting, shot on Canon EOS R5, 85mm lens',
  'A photorealistic photograph of [subject], casual composition, slightly messy, everyday life, natural colors',
  'A photorealistic close-up photograph of [subject], shallow depth of field, bokeh background, warm tones',
  'A photorealistic photograph of [subject], overhead shot, flat lay style, clean but natural',
  'A photorealistic photograph of [subject], outdoor natural light, golden hour, candid moment'
];
const defaultTips = [
  'Look for natural imperfections â€” real photos have dust, slight blur, and uneven lighting.',
  'Check edges carefully â€” AI often produces halos or unnatural blending where objects meet.',
  'Examine text and labels â€” AI struggles with readable, consistent lettering.',
  'Look at reflections â€” real reflections match the environment, AI reflections are often random.',
  'Check for symmetry â€” AI tends to make things too perfect and symmetrical.'
];

let prompts = [...defaultPrompts];
let tips = [...defaultTips];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.addEventListener('DOMContentLoaded', () => {
  // Load saved keys
  document.getElementById('key-unsplash').value = localStorage.getItem('braiain_key_unsplash') || '';
  document.getElementById('key-pexels').value = localStorage.getItem('braiain_key_pexels') || '';
  document.getElementById('key-gemini').value = localStorage.getItem('braiain_key_gemini') || '';

  document.getElementById('key-unsplash').addEventListener('input', e =>
    localStorage.setItem('braiain_key_unsplash', e.target.value.trim()));
  document.getElementById('key-pexels').addEventListener('input', e =>
    localStorage.setItem('braiain_key_pexels', e.target.value.trim()));
  document.getElementById('key-gemini').addEventListener('input', e =>
    localStorage.setItem('braiain_key_gemini', e.target.value.trim()));

  const savedModel = localStorage.getItem('braiain_gemini_model');
  if (savedModel) document.getElementById('gemini-model').value = savedModel;
  document.getElementById('gemini-model').addEventListener('change', e =>
    localStorage.setItem('braiain_gemini_model', e.target.value));

  document.getElementById('us-query').addEventListener('keydown', e => {
    if (e.key === 'Enter') searchPhotos();
  });

  // â”€â”€ Default date to today, auto-calc day number â”€â”€
  const today = new Date();
  document.getElementById('cfg-date').value = today.toISOString().split('T')[0];

  // Day 9 = 2026-02-12 is the last known entry
  const knownDay = 9;
  const knownDate = new Date('2026-02-12T12:00:00');
  today.setHours(12, 0, 0, 0);
  const diffDays = Math.round((today - knownDate) / 86400000);
  document.getElementById('cfg-day').value = Math.max(knownDay + diffDays, knownDay);

  renderRealStrip();
  renderAIStrip();
  renderAICards();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHOTO SOURCE TOGGLE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setPhotoSource(src) {
  photoSource = src;
  document.querySelectorAll('#photo-source-toggle button').forEach(b => {
    b.classList.toggle('active', b.dataset.src === src);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTO TAGLINE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function autoTagline() {
  const key = document.getElementById('key-gemini').value.trim();
  if (!key) return stat('import-status', 'Enter Google AI key in Step 2', 'err');
  const theme = document.getElementById('cfg-cat').value.trim();
  if (!theme) return stat('import-status', 'Enter a theme first', 'err');

  const date = document.getElementById('cfg-date').value;
  const d = new Date(date + 'T12:00:00');
  const formatted = d.toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric', year:'numeric' });

  stat('import-status', 'Generating taglineâ€¦');
  try {
    const resp = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`,
      {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text:
          `Generate a short, witty subtitle for a daily AI image detection game.
Theme: "${theme}" | Date: ${formatted}
Rules: 5-12 words, fun/cheeky, theme-related. Similar to:
"Post-Super Bowl Recovery â€” It's Pizza Time!"
"Rain, Snow, or AI â€” They Always Deliver"
Return ONLY the tagline, no quotes.`
        }], role: 'user' }] })
      }
    );
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    const text = (data.candidates?.[0]?.content?.parts?.[0]?.text || '').trim().replace(/^["']|["']$/g, '');
    if (text) {
      document.getElementById('cfg-subtitle').value = text;
      stat('import-status', 'Tagline generated âœ“', 'ok');
    } else throw new Error('Empty');
  } catch (e) { stat('import-status', 'Failed: ' + e.message, 'err'); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WHAT'S TODAY?
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function lookupDays() {
  const key = document.getElementById('key-gemini').value.trim();
  if (!key) return stat('days-status', 'Enter Google AI key in Step 2', 'err');
  const date = document.getElementById('cfg-date').value;
  if (!date) return stat('days-status', 'Pick a date first', 'err');

  const d = new Date(date + 'T12:00:00');
  const formatted = d.toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric', year:'numeric' });
  stat('days-status', `Looking up ${formatted}â€¦`);
  document.getElementById('days-list').innerHTML = '';

  try {
    const resp = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`,
      {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text:
          `What national days, international days, awareness days, food days, and fun holidays fall on ${formatted}?
Include well-known and obscure. Also major events or seasonal themes.
Return as JSON array: [{"name":"National Pizza Day","emoji":"ğŸ•"}]
ONLY JSON, no other text. 10-20 results, prioritize visually interesting themes.`
        }], role: 'user' }] })
      }
    );
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const jsonStr = text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
    const days = JSON.parse(jsonStr);
    if (!Array.isArray(days) || !days.length) throw new Error('No days found');

    const list = document.getElementById('days-list');
    list.innerHTML = '';
    days.forEach(day => {
      const chip = document.createElement('div');
      chip.className = 'day-chip';
      chip.innerHTML = `<span class="day-emoji">${day.emoji||'ğŸ“…'}</span>${day.name}`;
      chip.onclick = () => {
        document.getElementById('cfg-cat').value = day.name;
        document.getElementById('cfg-emoji').value = day.emoji || 'ğŸ“…';
        document.getElementById('us-query').value = day.name.replace(/^(National|International|World)\s+/i,'').replace(/\s+Day$/i,'');
        list.querySelectorAll('.day-chip').forEach(c => c.classList.remove('picked'));
        chip.classList.add('picked');
        stat('days-status', `Selected: ${day.name}`, 'ok');
        autoTagline();
      };
      list.appendChild(chip);
    });
    stat('days-status', `${days.length} days found. Click to use â†’`, 'ok');
  } catch (e) { stat('days-status', 'Failed: ' + e.message, 'err'); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IMPORT JSON
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      document.getElementById('cfg-day').value = data.day_number || 1;
      document.getElementById('cfg-date').value = data.date || '';
      document.getElementById('cfg-cat').value = data.category || '';
      document.getElementById('cfg-emoji').value = data.category_emoji || '';
      document.getElementById('cfg-subtitle').value = data.category_subtitle || '';
      let aiIdx = 0;
      if (data.rounds) {
        data.rounds.forEach(r => {
          if (r.source === 'ai' && aiIdx < 5) {
            tips[aiIdx] = r.pro_tip || defaultTips[aiIdx];
            if (r._note) prompts[aiIdx] = r._note.replace('Prompt: ', '');
            aiIdx++;
          }
        });
      }
      renderAICards();
      stat('import-status', `Loaded day ${data.day_number} â€” "${data.category}"`, 'ok');
    } catch (e) { stat('import-status', 'Invalid JSON: ' + e.message, 'err'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHOTO SEARCH â€” UNSPLASH + PEXELS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function searchPhotos() {
  const q = document.getElementById('us-query').value.trim();
  if (!q) return stat('us-status', 'Type a search term', 'err');

  photoResults = [];
  stat('us-status', 'Searchingâ€¦');
  const promises = [];

  if (photoSource === 'unsplash' || photoSource === 'both') {
    const k = document.getElementById('key-unsplash').value.trim();
    if (k) promises.push(searchUnsplash(q, k));
    else if (photoSource === 'unsplash') return stat('us-status', 'Enter Unsplash key', 'err');
  }
  if (photoSource === 'pexels' || photoSource === 'both') {
    const k = document.getElementById('key-pexels').value.trim();
    if (k) promises.push(searchPexels(q, k));
    else if (photoSource === 'pexels') return stat('us-status', 'Enter Pexels key', 'err');
  }
  if (!promises.length) return stat('us-status', 'No API keys for selected source', 'err');

  try {
    const results = await Promise.allSettled(promises);
    results.forEach(r => { if (r.status === 'fulfilled' && r.value) photoResults.push(...r.value); });
    if (photoSource === 'both') photoResults.sort(() => Math.random() - 0.5);
    stat('us-status', `${photoResults.length} results`, 'ok');
    renderPhotoGrid();
  } catch (e) { stat('us-status', e.message, 'err'); }
}

async function searchUnsplash(q, key) {
  const r = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(q)}&per_page=24&orientation=landscape`,
    { headers: { Authorization: `Client-ID ${key}` } });
  if (!r.ok) throw new Error('Unsplash: ' + (r.status===401 ? 'Invalid key' : 'HTTP '+r.status));
  const d = await r.json();
  return d.results.map(p => ({
    id: 'us_'+p.id, platform: 'unsplash',
    thumb: p.urls.small, full: p.urls.raw+'&w=800&h=600&fit=crop&q=80',
    photographer: p.user.name, desc: p.alt_description||'Untitled',
    sourceUrl: p.links.html, attribution: `Photo by ${p.user.name} on Unsplash`,
  }));
}

async function searchPexels(q, key) {
  const r = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(q)}&per_page=24&orientation=landscape`,
    { headers: { Authorization: key } });
  if (!r.ok) throw new Error('Pexels: ' + (r.status===401 ? 'Invalid key' : 'HTTP '+r.status));
  const d = await r.json();
  return d.photos.map(p => ({
    id: 'px_'+p.id, platform: 'pexels',
    thumb: p.src.medium, full: p.src.large,
    photographer: p.photographer, desc: p.alt||'Untitled',
    sourceUrl: p.url, attribution: `Photo by ${p.photographer} on Pexels`,
  }));
}

function renderPhotoGrid() {
  const g = document.getElementById('us-grid');
  g.innerHTML = '';
  photoResults.forEach(p => {
    const sel = REAL.some(r => r && r.id === p.id);
    const c = document.createElement('div');
    c.className = 'img-card' + (sel ? ' selected' : '');
    c.innerHTML = `
      <img src="${p.thumb}" loading="lazy">
      <div class="src-badge ${p.platform}">${p.platform==='pexels'?'PX':'US'}</div>
      <div class="meta"><b>${p.photographer}</b><br>${p.desc.slice(0,55)}</div>
      <div class="sel-badge">âœ“ REAL</div>`;
    c.onclick = () => toggleReal(p);
    g.appendChild(c);
  });
}

function toggleReal(photo) {
  const idx = REAL.findIndex(r => r && r.id === photo.id);
  if (idx >= 0) { REAL[idx] = null; }
  else {
    const empty = REAL.findIndex(r => r === null);
    if (empty < 0) return stat('us-status', 'All 5 full â€” remove one first', 'err');
    REAL[empty] = photo;
  }
  renderPhotoGrid(); renderRealStrip();
}

function removeReal(i) { REAL[i] = null; renderPhotoGrid(); renderRealStrip(); }

function renderRealStrip() {
  const s = document.getElementById('real-strip'); s.innerHTML = '';
  let count = 0;
  for (let i = 0; i < 5; i++) {
    if (REAL[i]) {
      count++;
      s.innerHTML += `<div class="slot" style="border:2px solid var(--green)">
        <img src="${REAL[i].thumb}"><button class="rm" onclick="removeReal(${i})">âœ•</button>
        <div class="sn" style="color:var(--green)">REAL ${i+1}</div></div>`;
    } else s.innerHTML += `<div class="slot-empty human">REAL ${i+1}</div>`;
  }
  document.getElementById('real-count').textContent = count;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GEMINI â€” AI IMAGES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAICards() {
  const wrap = document.getElementById('ai-cards'); wrap.innerHTML = '';
  for (let i = 0; i < 5; i++) {
    const card = document.createElement('div');
    card.className = 'ai-card'; card.id = `aic-${i}`;
    card.innerHTML = `
      <div class="ai-num">AI IMAGE ${i+1}</div>
      <textarea id="prompt-${i}" rows="2">${prompts[i]}</textarea>
      <div class="actions">
        <button class="btn btn-orange btn-sm" id="gen-${i}" onclick="geminiGen(${i})">GENERATE</button>
        <button class="btn btn-cyan btn-sm" onclick="copyPrompt(${i})">ğŸ“‹ COPY PROMPT</button>
        <button class="btn btn-outline btn-sm" onclick="document.getElementById('up-${i}').click()">UPLOAD</button>
        <input type="file" id="up-${i}" accept="image/*" style="display:none" onchange="handleUpload(${i},event)">
        <span class="status" id="ai-st-${i}"></span>
      </div>
      <div class="preview" id="prev-${i}"></div>
      <div class="tip-row">
        <label>Pro tip (shown after reveal)</label>
        <input id="tip-${i}" value="${tips[i]}">
      </div>`;
    wrap.appendChild(card);
  }
}

function copyPrompt(i) {
  const p = document.getElementById(`prompt-${i}`).value.trim();
  if (!p) return stat(`ai-st-${i}`, 'No prompt', 'err');
  navigator.clipboard.writeText(p).then(() =>
    stat(`ai-st-${i}`, 'Copied! Paste into Gemini web, then upload result here.', 'ok')
  ).catch(() => stat(`ai-st-${i}`, 'Copy failed', 'err'));
}

async function geminiGen(i) {
  const key = document.getElementById('key-gemini').value.trim();
  if (!key) return stat(`ai-st-${i}`, 'Enter Google AI key', 'err');
  const prompt = document.getElementById(`prompt-${i}`).value.trim();
  if (!prompt) return stat(`ai-st-${i}`, 'Write a prompt first', 'err');

  const model = document.getElementById('gemini-model').value;
  const btn = document.getElementById(`gen-${i}`);
  btn.disabled = true; btn.innerHTML = '<span class="spin"></span> WAITâ€¦';
  stat(`ai-st-${i}`, `Calling ${model}â€¦`);

  try {
    let resp, data;

    if (model === 'imagen-3.0-generate-002') {
      resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:predict?key=${key}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ instances: [{ prompt }], parameters: { sampleCount: 1, aspectRatio: '4:3' } })
      });
      if (!resp.ok) { const e = await resp.json().catch(()=>({})); throw new Error(e.error?.message || 'HTTP '+resp.status); }
      data = await resp.json();
      const prev = document.getElementById(`prev-${i}`);
      let found = false;
      if (data.predictions) {
        for (const pred of data.predictions) {
          if (pred.bytesBase64Encoded) {
            const b64 = pred.bytesBase64Encoded, mime = 'image/png';
            const dataUrl = `data:${mime};base64,${b64}`;
            const bytes = atob(b64), arr = new Uint8Array(bytes.length);
            for (let j = 0; j < bytes.length; j++) arr[j] = bytes.charCodeAt(j);
            const blob = new Blob([arr], { type: mime });
            const img = document.createElement('img');
            img.src = dataUrl; img.title = 'Click to select';
            img.onclick = () => pickAI(i, blob, dataUrl, prompt, img);
            prev.appendChild(img);
            if (!AI[i]) pickAI(i, blob, dataUrl, prompt, img);
            found = true;
          }
        }
      }
      if (!found) throw new Error('No image returned');
    } else {
      resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }], role: 'user' }],
          generationConfig: { responseModalities: ['TEXT', 'IMAGE'] }
        })
      });
      if (!resp.ok) { const e = await resp.json().catch(()=>({})); throw new Error(e.error?.message || 'HTTP '+resp.status); }
      data = await resp.json();
      let found = false;
      const prev = document.getElementById(`prev-${i}`);
      if (data.candidates?.[0]?.content?.parts) {
        for (const part of data.candidates[0].content.parts) {
          if (part.inlineData) {
            const mime = part.inlineData.mimeType || 'image/png';
            const b64 = part.inlineData.data;
            const dataUrl = `data:${mime};base64,${b64}`;
            const bytes = atob(b64), arr = new Uint8Array(bytes.length);
            for (let j = 0; j < bytes.length; j++) arr[j] = bytes.charCodeAt(j);
            const blob = new Blob([arr], { type: mime });
            const img = document.createElement('img');
            img.src = dataUrl; img.title = 'Click to select';
            img.onclick = () => pickAI(i, blob, dataUrl, prompt, img);
            prev.appendChild(img);
            if (!AI[i]) pickAI(i, blob, dataUrl, prompt, img);
            found = true;
          }
        }
      }
      if (!found) throw new Error('No image â€” use Copy Prompt â†’ Gemini web â†’ Upload');
    }
    stat(`ai-st-${i}`, 'Done âœ“', 'ok');
  } catch (e) {
    stat(`ai-st-${i}`, e.message, 'err');
  }
  btn.disabled = false; btn.innerHTML = 'GENERATE';
}

function pickAI(i, blob, dataUrl, prompt, imgEl) {
  AI[i] = { blob, dataUrl, prompt };
  const prev = document.getElementById(`prev-${i}`);
  prev.querySelectorAll('img').forEach(im => im.classList.remove('picked'));
  imgEl.classList.add('picked');
  renderAIStrip();
}

function handleUpload(i, e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const dataUrl = ev.target.result;
    AI[i] = { blob: file, dataUrl, prompt: document.getElementById(`prompt-${i}`).value };
    const prev = document.getElementById(`prev-${i}`);
    prev.innerHTML = '';
    const img = document.createElement('img');
    img.src = dataUrl; img.classList.add('picked');
    prev.appendChild(img);
    stat(`ai-st-${i}`, 'Uploaded âœ“', 'ok');
    renderAIStrip();
  };
  reader.readAsDataURL(file);
}

function removeAI(i) { AI[i] = null; renderAIStrip(); }

function renderAIStrip() {
  const s = document.getElementById('ai-strip'); s.innerHTML = '';
  let count = 0;
  for (let i = 0; i < 5; i++) {
    if (AI[i]) {
      count++;
      s.innerHTML += `<div class="slot" style="border:2px solid var(--red)">
        <img src="${AI[i].dataUrl}"><button class="rm" onclick="removeAI(${i})">âœ•</button>
        <div class="sn" style="color:var(--red)">AI ${i+1}</div></div>`;
    } else s.innerHTML += `<div class="slot-empty ai">AI ${i+1}</div>`;
  }
  document.getElementById('ai-count').textContent = count;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUGGEST PROMPTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function suggestPrompts() {
  const key = document.getElementById('key-gemini').value.trim();
  if (!key) return stat('ai-status-global', 'Enter Google AI key', 'err');
  const theme = document.getElementById('cfg-cat').value.trim();
  if (!theme) return stat('ai-status-global', 'Enter a theme first', 'err');

  const realDescs = REAL.filter(Boolean).map((p,i) => `Real ${i+1}: ${p.desc}`).join('\n');
  const ctx = realDescs ? `\n\nReal photos selected:\n${realDescs}\nMatch similar subjects to make AI hard to distinguish.` : '';

  stat('ai-status-global', 'Generating promptsâ€¦');
  try {
    const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text:
        `Theme: "${theme}". Generate 5 photorealistic image prompts for AI image generation.
Each: starts with "A photorealistic photograph of", includes camera/lighting details, varies composition.${ctx}
Return ONLY 5 prompts numbered 1-5.`
      }], role: 'user' }] })
    });
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    const lines = (data.candidates?.[0]?.content?.parts?.[0]?.text || '').split('\n')
      .map(l => l.replace(/^\d+[\.\)]\s*/, '').trim()).filter(l => l.length > 20);
    if (lines.length < 5) throw new Error('Bad response â€” retry');
    for (let i = 0; i < 5; i++) {
      const el = document.getElementById(`prompt-${i}`);
      if (el && lines[i]) el.value = lines[i];
    }
    stat('ai-status-global', 'Prompts filled âœ“', 'ok');
  } catch (e) { stat('ai-status-global', 'Failed: ' + e.message, 'err'); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GENERATE ALL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function generateAllAI() {
  const key = document.getElementById('key-gemini').value.trim();
  if (!key) return stat('ai-status-global', 'Enter Google AI key', 'err');
  const btn = document.getElementById('gen-all-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spin"></span> GENERATINGâ€¦';
  let ok = 0, fail = 0;
  for (let i = 0; i < 5; i++) {
    if (!document.getElementById(`prompt-${i}`).value.trim()) { fail++; continue; }
    if (AI[i]) { ok++; continue; }
    stat('ai-status-global', `Generating ${i+1}/5â€¦`);
    try { await geminiGen(i); if (AI[i]) ok++; else fail++; } catch(e) { fail++; }
    if (i < 4) await sleep(2000);
  }
  btn.disabled = false; btn.innerHTML = 'ğŸš€ GENERATE ALL';
  stat('ai-status-global', `${ok} done, ${fail} failed${fail ? ' â€” use Copy Prompt for failed' : ''}`, fail ? 'err' : 'ok');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTO TIPS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function autoTips() {
  const key = document.getElementById('key-gemini').value.trim();
  if (!key) return stat('ai-status-global', 'Enter Google AI key', 'err');
  const theme = document.getElementById('cfg-cat').value.trim();
  const aiP = []; for (let i=0;i<5;i++) aiP.push(document.getElementById(`prompt-${i}`).value.trim());
  if (aiP.every(p => !p)) return stat('ai-status-global', 'Fill prompts first', 'err');

  const realDescs = REAL.filter(Boolean).map((p,i) => `Real ${i+1}: ${p.desc}`).join('\n');
  stat('ai-status-global', 'Generating tipsâ€¦');
  try {
    const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text:
        `Write pro tips for AI detection game. Theme: "${theme||'General'}"
AI prompts:\n${aiP.map((p,i)=>`${i+1}. ${p}`).join('\n')}
${realDescs ? `Real photos:\n${realDescs}\nWrite 10 tips: 1-5 for AI, 6-10 for real.` : 'Write 5 tips for AI images.'}
Each tip: CATEGORY: in caps, 1-2 sentences, max 30 words, specific visual tells.
Numbered list only.`
      }], role: 'user' }] })
    });
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    const lines = (data.candidates?.[0]?.content?.parts?.[0]?.text || '').split('\n')
      .map(l => l.replace(/^\d+[\.\)]\s*/, '').trim()).filter(l => l.length > 15);
    for (let i=0;i<5&&i<lines.length;i++) {
      const el = document.getElementById(`tip-${i}`);
      if (el && lines[i]) el.value = lines[i];
    }
    window._realTips = [];
    for (let i=5;i<10&&i<lines.length;i++) window._realTips.push(lines[i]);
    stat('ai-status-global', 'Tips generated âœ“', 'ok');
  } catch (e) { stat('ai-status-global', 'Failed: ' + e.message, 'err'); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PREVIEW
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildShuffledItems() {
  if (REAL.filter(Boolean).length < 5 || AI.filter(Boolean).length < 5) return null;
  const items = [];
  for (let i=0;i<5;i++) items.push({ source:'human', thumb:REAL[i].thumb, label:`Real ${i+1}` });
  for (let i=0;i<5;i++) items.push({ source:'ai', thumb:AI[i].dataUrl, label:`AI ${i+1}` });
  for (let i=items.length-1;i>0;i--) { const j=Math.floor(Math.random()*(i+1));[items[i],items[j]]=[items[j],items[i]]; }
  return items;
}

function renderPreview() {
  const items = buildShuffledItems();
  if (!items) return stat('preview-status', 'Need 5 real + 5 AI first', 'err');
  const grid = document.getElementById('preview-grid'); grid.innerHTML = '';
  items.forEach((item,idx) => {
    const card = document.createElement('div'); card.className = 'preview-card';
    card.innerHTML = `<img src="${item.thumb}">
      <div class="round-num">R${idx+1}</div>
      <div class="type-badge ${item.source==='ai'?'ai':'human'}">${item.source==='ai'?'AI':'REAL'}</div>`;
    grid.appendChild(card);
  });

  const warnings = [];
  let ms=1,cs=1;
  for(let i=1;i<items.length;i++){if(items[i].source===items[i-1].source){cs++;if(cs>ms)ms=cs;}else cs=1;}
  if(ms>=3) warnings.push(`âš ï¸ ${ms} same type in a row`);
  let alt=true;for(let i=1;i<items.length;i++){if(items[i].source===items[i-1].source){alt=false;break;}}
  if(alt) warnings.push('âš ï¸ Perfect alternation â€” re-shuffle');

  const wb = document.getElementById('pattern-warning');
  if (warnings.length) { wb.innerHTML = warnings.join('<br>'); wb.classList.add('visible'); }
  else wb.classList.remove('visible');

  const qBar = document.getElementById('quality-bar'); qBar.style.display = 'flex';
  const pattern = items.map(i=>i.source==='ai'?'A':'R').join('');
  const aiF = items.slice(0,5).filter(i=>i.source==='ai').length;
  qBar.innerHTML = `
    <div class="q-stat"><div class="q-label">Pattern</div><div class="q-val" style="color:var(--cyan);font-size:.6rem;letter-spacing:2px">${pattern}</div></div>
    <div class="q-stat"><div class="q-label">Balance</div><div class="q-val ${Math.abs(aiF-2.5)<=1.5?'good':'warn'}">${aiF}A+${5-aiF}R / ${5-aiF+items.slice(5).filter(i=>i.source==='ai').length}A</div></div>
    <div class="q-stat"><div class="q-label">Max Streak</div><div class="q-val ${ms<=2?'good':ms<=3?'warn':'bad'}">${ms}</div></div>
    <div class="q-stat"><div class="q-label">Quality</div><div class="q-val ${warnings.length===0?'good':'warn'}">${warnings.length===0?'CLEAN âœ“':warnings.length+' warn'}</div></div>`;
  stat('preview-status', 'Preview ready', 'ok');
}
function reshufflePreview() { renderPreview(); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function generateJSON() {
  const day = parseInt(document.getElementById('cfg-day').value) || 1;
  const date = document.getElementById('cfg-date').value;
  const cat = document.getElementById('cfg-cat').value.trim();
  const emoji = document.getElementById('cfg-emoji').value.trim();
  const subtitle = document.getElementById('cfg-subtitle').value.trim();

  const rc = REAL.filter(Boolean).length, ac = AI.filter(Boolean).length;
  if (rc<5||ac<5) return stat('export-status', `Need 5 real (${rc}) + 5 AI (${ac})`, 'err');

  const items = [];
  for (let i=0;i<5;i++) {
    const p = REAL[i];
    const realTip = window._realTips?.[i] || 'Natural imperfections like lens flare, slight blur, or uneven lighting are hallmarks of a real photograph.';
    items.push({ source:'human', content:p.full, attribution:p.attribution, source_url:p.sourceUrl, pro_tip:realTip });
  }
  for (let i=0;i<5;i++) {
    const ext = AI[i].blob.type?.includes('png') ? 'png' : 'jpg';
    items.push({ source:'ai', content:`images/d${day}_ai${i+1}.${ext}`, attribution:'AI-generated â€” created with Google Gemini',
      pro_tip: document.getElementById(`tip-${i}`).value || tips[i],
      _prompt: document.getElementById(`prompt-${i}`).value, _ext: ext });
  }

  let best=null,bestS=-999;
  for(let a=0;a<20;a++){
    const sh=[...items];for(let i=sh.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[sh[i],sh[j]]=[sh[j],sh[i]];}
    let sc=10,st=1;
    for(let i=1;i<sh.length;i++){if(sh[i].source===sh[i-1].source){st++;if(st>=3)sc-=3;if(st>=4)sc-=5;}else st=1;}
    let al=true;for(let i=1;i<sh.length;i++){if(sh[i].source===sh[i-1].source){al=false;break;}}if(al)sc-=10;
    const af=sh.slice(0,5).filter(i=>i.source==='ai').length;if(Math.abs(af-2.5)>1.5)sc-=2;
    if(sh.slice(0,3).every(s=>s.source===sh[0].source))sc-=2;
    if(sh.slice(-3).every(s=>s.source===sh[9]?.source))sc-=2;
    if(sc>bestS){bestS=sc;best=sh;}if(sc>=9)break;
  }

  const rounds = best.map((item,idx) => {
    const r = { id:`d${day}r${idx+1}`, type:'image', content:item.content, source:item.source, attribution:item.attribution, pro_tip:item.pro_tip };
    if (item.source_url) r.source_url = item.source_url;
    if (item._prompt) r._note = `Prompt: ${item._prompt}`;
    return r;
  });

  const challenge = { day_number:day, date, category:cat||'Daily Challenge', category_emoji:emoji||'ğŸ§ ', rounds };
  if (subtitle) challenge.category_subtitle = subtitle;

  document.getElementById('json-out').value = JSON.stringify(challenge, null, 2);

  // â”€â”€ Daily.json snippet â”€â”€
  const entry = { day_number: day, category: cat||'Daily Challenge', category_emoji: emoji||'ğŸ§ ' };
  if (subtitle) entry.category_subtitle = subtitle;
  entry.challenge_file = `challenges/${date}.json`;

  const snippet = `  "${date}": ${JSON.stringify(entry, null, 4).split('\n').map((l,i) => i===0?l:'  '+l).join('\n')}`;
  document.getElementById('daily-json-out').value = snippet;

  const pattern = best.map(i=>i.source==='ai'?'A':'R').join('');
  stat('export-status', `âœ“ ${rounds.length} rounds. Pattern: ${pattern} (${bestS}/10). Daily snippet ready.`, bestS>=7?'ok':'err');
}

async function downloadAll() {
  const json = document.getElementById('json-out').value;
  if (!json) return stat('export-status', 'Generate JSON first', 'err');
  const day = parseInt(document.getElementById('cfg-day').value)||1;
  const date = document.getElementById('cfg-date').value;
  stat('export-status', 'Downloadingâ€¦');
  dlBlob(new Blob([json],{type:'application/json'}), `${date}.json`);
  for (let i=0;i<5;i++) {
    if (AI[i]) {
      const ext = AI[i].blob.type?.includes('png')?'png':'jpg';
      dlBlob(AI[i].blob, `d${day}_ai${i+1}.${ext}`);
      await sleep(350);
    }
  }
  stat('export-status', `Downloaded! JSON â†’ challenges/${date}.json, images â†’ images/, paste daily.json snippet.`, 'ok');
}

function copyJSON() {
  const v = document.getElementById('json-out').value; if(!v) return;
  navigator.clipboard.writeText(v); stat('export-status', 'Challenge JSON copied âœ“', 'ok');
}
function copyDailyJSON() {
  const v = document.getElementById('daily-json-out').value; if(!v) return;
  navigator.clipboard.writeText(v); stat('export-status', 'Daily.json snippet copied âœ“ â€” paste before last } in daily.json', 'ok');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function stat(id,msg,type='') { const el=document.getElementById(id); if(!el)return; el.textContent=msg; el.className='status'+(type?' '+type:''); }
function dlBlob(blob,name) { const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href); }
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
</script>
</body>
</html>
